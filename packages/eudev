#!/bin/bash

source "$(dirname "$0")"/../common/common_source

NAME=eudev
VERSION=$EUDEV_VER
TARFILE=$NAME-$VERSION.tar.gz
FETCH_URL="https://dev.gentoo.org/~blueness/eudev/$TARFILE"
FETCH_LFS="https://anduin.linuxfromscratch.org/LFS/udev-lfs-20171102.tar.xz"
mSBU=200

provide_source_urls()
{
    echo $FETCH_URL $FETCH_LFS
    return 0
}

fetch()
{
    warn_if_missing $FETCH_URL $TARFILE
    warn_if_missing $FETCH_LFS $(basename $FETCH_LFS)
}

configure()
{
    cd "$WORKBENCH/$NAME-$VERSION"
    BUILD_PATH=$(pwd)

    ./configure --prefix=/usr \
            --bindir=/usr/sbin \
            --sysconfdir=/etc \
            --enable-manpages \
            --disable-static >>"$LOGFILE" 2>&1
}

build_install()
{
    cd "$BUILD_PATH"
    {
    mkdir -pv /usr/lib/udev/rules.d
    mkdir -pv /etc/udev/rules.d
    make $MAKE_JOBS install
    } >>"$LOGFILE" 2>&1
}

post_install()
{
    cd "$WORKBENCH"

    # Install some custom rules and support files for LFS environment
    local lfsfile=$(basename $FETCH_LFS)
    {
    cp -vf "$SRCDIR/$lfsfile" "$WORKBENCH"
    tar -xvf $lfsfile
    make $SILENT_MAKE $MAKE_JOBS -f udev-lfs-20171102/Makefile.lfs install >>"$LOGFILE" 2>&1
    [ $? -ne 0 ] && return 1
    udevadm hwdb --update
    } >>"$LOGFILE" 2>&1
}

cleanup()
{
    default_cleanup "$WORKBENCH/$NAME-$VERSION"
    default_cleanup "$WORKBENCH"/udev-lfs-20171102
}

source "$(dirname "$0")"/../common/common_exec

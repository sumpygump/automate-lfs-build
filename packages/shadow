#!/bin/bash

source "$(dirname "$0")"/../common/common_source

NAME=shadow
VERSION=$SHADOW_VER
TARFILE=$NAME-$VERSION.tar.xz
FETCH_URL="https://github.com/shadow-maint/shadow/releases/download/v$VERSION/$TARFILE"
mSBU=200

patchup()
{
    cd "$WORKBENCH/$NAME-$VERSION"
    {
    # Disable install of groups as coreutils has a better version
    sed -i 's/groups$(EXEEXT) //' src/Makefile.in
    find man -name Makefile.in -exec sed -i 's/groups\.1 / /'   {} \; &&
    find man -name Makefile.in -exec sed -i 's/getspnam\.3 / /' {} \; &&
    find man -name Makefile.in -exec sed -i 's/passwd\.5 / /'   {} \;

    # use more secure sha-512 method of password encryption
    sed -e 's:#ENCRYPT_METHOD DES:ENCRYPT_METHOD SHA512:' \
        -e 's:/var/spool/mail:/var/mail:'                 \
        -e '/PATH=/{s@/sbin:@@;s@/bin:@@}'                \
        -i etc/login.defs

    # Fix a simple programming error
    sed -e "224s/rounds/min_rounds/" -i libmisc/salt.c
    } >>"$LOGFILE" 2>&1 
}

configure()
{
    cd "$WORKBENCH/$NAME-$VERSION"
    BUILD_PATH=$(pwd)

    touch /usr/bin/passwd
    ./configure \
        --sysconfdir=/etc \
        --with-group-name-max-length=32 >>"$LOGFILE" 2>&1
}

build_install()
{
    {
    cd $BUILD_PATH
    make $MAKE_JOBS exec_prefix=/usr install
    make -C man install-man
    mkdir -p /etc/default
    useradd -D --gid 999
    }>>"$LOGFILE" 2>&1
}

source "$(dirname "$0")"/../common/common_exec

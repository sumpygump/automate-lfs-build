#!/bin/bash

source "$(dirname "$0")"/../common/common_source

NAME=linux
VERSION=$LINUX_VER
TARFILE=$NAME-$VERSION.tar.xz
FETCH_URL="https://www.kernel.org/pub/linux/kernel/v5.x/$TARFILE"
mSBU=9200

configure()
{
    cd "$WORKBENCH/$NAME-$VERSION"
    mkdir build

    make O=build x86_64_defconfig >>"$LOGFILE" 2>&1
    [ $? -ne 0 ] && return 1

    make O=build kvm_guest.config >>"$LOGFILE" 2>&1
    [ $? -ne 0 ] && return 1
    cd build
    BUILD_PATH=$(pwd)
}

build()
{
    cd "$BUILD_PATH"
    make "$MAKE_JOBS" >>"$LOGFILE" 2>&1
    make modules >>"$LOGFILE" 2>&1
}

build_install()
{
    cd "$BUILD_PATH"

    make modules_install >>"$LOGFILE" 2>&1
    make install >>"$LOGFILE" 2>&1

    {
    # Copy the kernel image to boot dir, named with specific version
    cp -iv arch/x86/boot/bzImage /boot/vmlinuz-$VERSION-lfs-11.0

    # Also copy the System.map file; used when investigating kernel problems
    cp -iv System.map /boot/System.map-$VERSION

    # Also copy the kernel config file we generated for this build
    cp -iv .config /boot/config-$VERSION

    # Install documentation for linux kernel
    install -d /usr/share/doc/linux-$VERSION
    cp -r ../Documentation/* /usr/share/doc/linux-$VERSION
    }>>"$LOGFILE" 2>&1
}

source "$(dirname "$0")"/../common/common_exec
